<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gym Journey â€” Track Your Workout Progress</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’ªğŸ¿</text></svg>"
    />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/cal-heatmap.min.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/cal-heatmap/dist/cal-heatmap.css"
    />
    <script src="https://unpkg.com/cal-heatmap/dist/plugins/Legend.min.js"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/plugins/Tooltip.min.js"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/plugins/LegendLite.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/plugins/Tooltip.min.js"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/plugins/CalendarLabel.min.js"></script>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.9/dist/basecoat.cdn.min.css"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.9/dist/js/all.min.js"
      defer
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <style>
      .progress-ring {
        transform: rotate(-90deg);
      }
      .progress-ring-circle {
        transition: stroke-dashoffset 0.5s ease-in-out;
      }
    </style>

    <script>
      (() => {
        try {
          const stored = localStorage.getItem("themeMode");
          if (
            stored
              ? stored === "dark"
              : matchMedia("(prefers-color-scheme: dark)").matches
          ) {
            document.documentElement.classList.add("dark");
          }
        } catch (_) {}

        const apply = (dark) => {
          document.documentElement.classList.toggle("dark", dark);
          try {
            localStorage.setItem("themeMode", dark ? "dark" : "light");
          } catch (_) {}
        };

        document.addEventListener("basecoat:theme", (event) => {
          const mode = event.detail?.mode;
          apply(
            mode === "dark"
              ? true
              : mode === "light"
              ? false
              : !document.documentElement.classList.contains("dark")
          );
        });
      })();
    </script>
  </head>
  <body class="overflow-x-hidden bg-background text-foreground">
    <div class="flex items-center justify-center min-h-svh p-4">
      <div class="w-full max-w-2xl relative">
        <button
          type="button"
          aria-label="Toggle dark mode"
          data-side="bottom"
          onclick="document.dispatchEvent(new CustomEvent('basecoat:theme'))"
          class="btn-icon-outline size-8 fixed top-4 right-4 z-50"
        >
          <span class="hidden dark:block"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="4" />
              <path d="M12 2v2" />
              <path d="M12 20v2" />
              <path d="m4.93 4.93 1.41 1.41" />
              <path d="m17.66 17.66 1.41 1.41" />
              <path d="M2 12h2" />
              <path d="M20 12h2" />
              <path d="m6.34 17.66-1.41 1.41" />
              <path d="m19.07 4.93-1.41 1.41" /></svg
          ></span>
          <span class="block dark:hidden"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" /></svg
          ></span>
        </button>

        <header class="mb-4">
          <h1
            class="scroll-m-20 text-3xl font-extrabold tracking-tight text-foreground lg:text-4xl"
          >
            Your Gym Journey
          </h1>
          <p class="text-lg text-muted-foreground">
            Goal:
            <span id="goal-text" class="text-[#4dd05a] font-semibold"
              >-- workouts</span
            >
            in 2026
          </p>
        </header>

        <div
          class="flex flex-wrap gap-x-4 gap-y-1 mb-3 text-sm font-medium leading-none"
        >
          <div class="flex items-center gap-2">
            <svg
              class="progress-ring"
              width="20"
              height="20"
              viewBox="0 0 36 36"
            >
              <circle
                cx="18"
                cy="18"
                r="16"
                fill="none"
                stroke="#3f3f46"
                stroke-width="3"
              />
              <circle
                id="progress-ring-circle"
                class="progress-ring-circle"
                cx="18"
                cy="18"
                r="16"
                fill="none"
                stroke="#22c55e"
                stroke-width="3"
                stroke-linecap="round"
              />
            </svg>
            <span class="text-muted-foreground"
              >Progress:
              <span id="progress-count" class="text-foreground font-semibold"
                >-- / 100</span
              >
              <span id="progress-percent" class="text-muted-foreground/70"
                >(---%)</span
              ></span
            >
          </div>
          <div class="flex items-center gap-2">
            <span>ğŸ”¥</span>
            <span class="text-muted-foreground"
              >Current streak:
              <span id="current-streak" class="text-foreground font-semibold"
                >-- days</span
              ></span
            >
          </div>
        </div>
        <div
          class="flex items-center gap-2 mb-4 text-sm font-medium leading-none"
        >
          <span>ğŸƒâ€â™‚ï¸â€â¡ï¸</span>
          <span class="text-muted-foreground"
            >Longest streak:
            <span id="longest-streak" class="text-foreground font-semibold"
              >-- days</span
            ></span
          >
        </div>

        <div class="card border-0 p-3 mb-2">
          <div class="flex items-center gap-2">
            <span class="text-primary">âœ”ï¸</span>
            <p class="text-sm font-medium leading-none text-foreground">
              This Week:
              <span id="week-progress" class="font-semibold">-- / --</span>
              workouts complete
            </p>
          </div>
          <div
            id="week-comparison"
            class="flex items-center gap-2 text-sm text-muted-foreground"
          >
            <span>ğŸ”¥</span>
            <span>Loading...</span>
          </div>
        </div>

        <div class="card border-0 p-3 mb-2">
          <div class="flex items-center gap-2">
            <span>ğŸ…</span>
            <p class="text-sm font-medium leading-none text-foreground">
              Next milestone:
              <span id="next-milestone" class="text-primary font-semibold"
                >--</span
              >
              workouts â€” only
              <span id="milestone-remaining" class="text-primary font-semibold"
                >--</span
              >
              to go!
            </p>
          </div>
        </div>

        <div class="mt-4 flex gap-4">
          <div class="overflow-x-auto flex-1">
            <div id="cal-heatmap-container" class="relative min-h-[180px]">
              <div
                id="cal-spinner"
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-10"
              >
                <span class="badge badge-secondary flex items-center gap-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    role="status"
                    aria-label="Loading"
                    class="animate-spin"
                  >
                    <path d="M21 12a9 9 0 1 1-6.219-8.56" />
                  </svg>
                  Syncing
                </span>
              </div>
              <div id="cal-heatmap"></div>
            </div>
          </div>
          <div class="flex flex-col gap-2 text-xs text-muted-foreground pt-6">
            <div class="flex items-center gap-1.5">
              <span
                class="w-3 h-3 rounded-sm"
                style="background-color: #f97316"
              ></span>
              <span>ğŸ‹ï¸ Pull</span>
            </div>
            <div class="flex items-center gap-1.5">
              <span
                class="w-3 h-3 rounded-sm"
                style="background-color: #3b82f6"
              ></span>
              <span>ğŸ’ª Push</span>
            </div>
            <div class="flex items-center gap-1.5">
              <span
                class="w-3 h-3 rounded-sm"
                style="background-color: #22c55e"
              ></span>
              <span>ğŸ¦µ Legs</span>
            </div>
            <div class="flex items-center gap-1.5">
              <span
                class="w-3 h-3 rounded-sm"
                style="background-color: #a855f7"
              ></span>
              <span>ğŸƒ Cardio</span>
            </div>
          </div>
        </div>

        <div role="group" class="button-group hidden md:flex">
          <button
            onclick="goPrev(event)"
            type="button"
            class="btn-sm-icon-outline"
            aria-label="Previous page"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="m15 18-6-6 6-6" />
            </svg>
          </button>
          <button
            onclick="goNext(event)"
            type="button"
            class="btn-sm-icon-outline"
            aria-label="Next page"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="m9 18 6-6-6-6" />
            </svg>
          </button>
        </div>

        <div
          class="card border-0 p-3 mt-3 cursor-pointer hover:bg-accent transition-colors"
          id="stats-card"
        >
          <div class="flex items-center justify-between">
            <div class="min-w-0 flex-1">
              <div class="flex flex-wrap items-center gap-x-2 gap-y-1 mb-1">
                <span class="text-lg">ğŸ“ˆ</span>
                <h4
                  class="text-sm font-semibold tracking-tight text-foreground"
                >
                  Stats
                </h4>
                <span class="text-muted-foreground hidden sm:inline">â€¢</span>
                <span
                  id="avg-workouts"
                  class="text-[11px] text-muted-foreground w-full sm:w-auto"
                  >You average -- workouts/week</span
                >
              </div>
              <p
                id="projection"
                class="text-[11px] text-muted-foreground/70 truncate"
              >
                At this pace, you'll hit 100 by --
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      (async function () {
        const API_BASE = "https://gym-api.senthil.nz";

        const [milestoneRes, statsRes, weekRes, forecastRes] =
          await Promise.allSettled([
            fetch(`${API_BASE}/visits/milestone`),
            fetch(`${API_BASE}/visits/stats`),
            fetch(`${API_BASE}/visits/weekly`),
            fetch(`${API_BASE}/visits/forecast`),
          ]);

        if (milestoneRes.status === "fulfilled") {
          const data = await milestoneRes.value.json();
          document.getElementById("next-milestone").textContent =
            data.next_milestone;
          document.getElementById("milestone-remaining").textContent =
            data.workouts_to_go;
        }

        if (statsRes.status === "fulfilled") {
          try {
            const data = await statsRes.value.json();
            const current = data.currentStreak;
            const goal = data.goal || 100;
            const percent = data.progress || 0;
            const currentStreak = data.currentStreak;
            const longestStreak = data.longestStreak;
            const totalWorkouts = data.total || 0;

            document.getElementById(
              "goal-text"
            ).textContent = `${goal} workouts`;
            document.getElementById(
              "progress-count"
            ).textContent = `${totalWorkouts} / ${goal}`;
            document.getElementById(
              "progress-percent"
            ).textContent = `(${percent}%)`;

            document.getElementById("current-streak").textContent =
              currentStreak;
            document.getElementById("longest-streak").textContent =
              longestStreak;

            const circle = document.getElementById("progress-ring-circle");
            const radius = 16;
            const circumference = 2 * Math.PI * radius; // ~100.53

            circle.setAttribute("stroke-dasharray", circumference);
            const offset = circumference - (percent / 100) * circumference;
            circle.setAttribute("stroke-dashoffset", offset);

            const avgPerWeek = data.avgPerWeek || 0;
            document.getElementById(
              "avg-workouts"
            ).textContent = `You average ${avgPerWeek.toFixed(
              1
            )} workouts/week`;

            if (data.projectedDate) {
              document.getElementById(
                "projection"
              ).textContent = `At this pace, you'll hit 100 by ${data.projectedDate}`;
            }
          } catch (err) {
            console.error("Failed to parse progress:", err);
          }
        }

        if (weekRes.status === "fulfilled") {
          try {
            const data = await weekRes.value.json();
            document.getElementById("week-progress").textContent = `${
              data.workouts_completed || 0
            } / ${data.weekly_goal || 4}`;

            const comparison = document.getElementById("week-comparison");
            comparison.innerHTML = data.progress_message;
          } catch (err) {
            console.error("Failed to parse week:", err);
          }
        }

        if (forecastRes.status === "fulfilled") {
          try {
            const data = await forecastRes.value.json();
            document.getElementById("avg-workouts").textContent =
              data.current_progress;
            document.getElementById("projection").textContent =
              data.future_forecast;
          } catch (err) {
            console.error("Failed to parse forecast:", err);
          }
        }

        const workoutColors = {
          Pull: "#f97316", // Orange
          Push: "#3b82f6", // Blue
          Legs: "#22c55e", // Green
          Cardio: "#a855f7", // Purple
        };

        const workoutToNumber = {
          Pull: 1,
          Push: 2,
          Legs: 3,
          Cardio: 4,
        };

        let workoutData = {};

        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), 1);

        const entryResponse = await fetch(`${API_BASE}/entry`);
        const entries = await entryResponse.json();

        entries.forEach((entry) => {
          const dateKey = entry.date.split("T")[0];
          workoutData[dateKey] = entry.workout;
        });

        const data = {
          source: entries,
          type: "json",
          x: "date",
          y: (d) => workoutToNumber[d.workout] || 0,
          groupY: "max",
        };

        window.cal = new CalHeatmap();
        await window.cal.paint(
          {
            itemSelector: "#cal-heatmap",
            theme: "dark",
            date: {
              start: start,
              timezone: "Pacific/Auckland",
            },
            range: 6,
            data: data,
            scale: {
              color: {
                type: "ordinal",
                range: ["#27272a", "#f97316", "#3b82f6", "#22c55e", "#a855f7"],
                domain: [0, 1, 2, 3, 4],
              },
            },
            domain: {
              type: "month",
              gutter: 4,
              label: { text: "MMM", textAlign: "start", position: "top" },
            },
            subDomain: {
              type: "ghDay",
              radius: 2,
              width: 14,
              height: 14,
              gutter: 4,
            },
          },
          [
            [
              Tooltip,
              {
                text: function (date, value, dayjsDate) {
                  const workoutEmojis = {
                    Pull: "ğŸ‹ï¸",
                    Push: "ğŸ’ª",
                    Legs: "ğŸ¦µ",
                    Cardio: "ğŸƒ",
                  };
                  const formattedDate = dayjsDate.format("dddd, MMMM D, YYYY");
                  if (dayjsDate.isAfter(dayjs())) {
                    return "ğŸ“… " + formattedDate + " - Upcoming";
                  }
                  const dateKey = dayjsDate.format("YYYY-MM-DD");
                  const workout = workoutData[dateKey];
                  if (workout) {
                    const emoji = workoutEmojis[workout] || "ğŸ’ª";
                    return emoji + " " + workout + " day - " + formattedDate;
                  }
                  return "ğŸ˜´ Rest day - " + formattedDate;
                },
              },
            ],
            [
              CalendarLabel,
              {
                width: 25,
                textAlign: "start",
                text: () => ["", "Mon", "", "Wed", "", "Fri", ""],
                padding: [25, 0, 0, 0],
              },
            ],
          ]
        );

        document.getElementById("cal-spinner")?.remove();
      })();

      function goNext(event) {
        event.preventDefault();
        window.cal.next();
      }

      function goPrev(event) {
        event.preventDefault();
        window.cal.previous();
      }
    </script>
  </body>
</html>
